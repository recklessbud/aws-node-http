# "org" ensures this Service is used with the correct Serverless Framework Access Key.
org: bureck
# "service" is the name of this project. This will also be added to your AWS resource names.
app: aws-node-http-start
service: aws-node-http-start
useDotenv: true


provider:
  name: aws
  runtime: nodejs20.x
  stage: dev
  region: us-east-1
  tracing:
    apiGateway: true
    lambda: true
  memorySize: 512
  timeout: 20
  httpApi:
    cors: true
    binaryMediaTypes:
      - "*/*"
  apiGateway:
    metrics: true
    shouldStartNameWithService: true
    minimumCompressionSize: 1024
  environment:
    STAGE: ${env:STAGE, 'prod'}

  iam:
    role:
      name:  ${self:service}-lambda-role-${env:STAGE, 'prod'}
      statements:
        - Effect: Allow
          Action:
            - "ssm:DescribeParameters"
            - "ssm:GetParameter"
            - "ssm:GetParameterHistory"
            - "ssm:GetParametersByPath"
            - "ssm:GetParameters"
            - "ec2:DescribeRegions"	
            - "ec2:CreateNetworkInterface"
            - "ec2:DeleteNetworkInterface"
            - "ec2:DescribeNetworkInterfaces"
            - "logs:CreateLogGroup"
            - "logs:CreateLogStream"
            - "logs:PutLogEvents"
          Resource: "*"
  vpc:
    securityGroupIds:
      - sg-0bf6a786b11fd7759
      - sg-0c6546935ce0a182d
      - sg-0e0ba72a6f73c4ba8
      - sg-07bc790d189347de3
      - sg-0c61d328c8947a508
    subnetIds:
      - subnet-087266d83f29b6de9
      - subnet-0c4f12559e2ae2e57
      - subnet-06fbc36506384f7f9
      - subnet-0a0739c11d57b4739
      - subnet-091b18809567a60f5
      - subnet-050f46c1fe2c68048

functions:
  hello:
    handler: src/index.handler
    events: 
    - httpApi: "*"
    timeout: 10
    memorySize: 256
    tags:
      Function: hello

package:
  patterns:
    - '!node_modules/.prisma/client/libquery_engine-*'
    - 'node_modules/.prisma/client/libquery_engine-rhel-*'
    - '!node_modules/prisma/libquery_engine-*'
    - '!node_modules/@prisma/engines/**'
    - '!node_modules/.cache/prisma/**' 
    - "!src/**/*.test.ts"
    - "!src/**/*.spec.ts"
    - "!src/**/*.test.js"
    - "!src/**/__tests__/**"
    - "!src/**/__mocks__/**"
    - "!.git/**"
    - "!.vscode/**"
    # - "!node_modules/**
    - "!test/**"
    - "!tests/**"
    - "src/views/**"
    - "node_modules/ejs/**"
    - "src/views/**/*.ejs"
    - "src/views/*/**"
    - "node_modules/ajv/**"
    - "node_modules/json-schema-traverse/**"
    - "node_modules/fast-deep-equal/**"
    - "node_modules/uri-js/**"

plugins:
  - serverless-offline
  - serverless-static
  - serverless-plugin-static
  - serverless-dotenv-plugin

custom:
  
  serverless-offline:
    httpPort: 4000
    lambdaPort: 4002
    noPrependStageInUrl: true
    reloadHandler: true
  dotenv:
    exclude:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY

  esbuild:
    bundle: true
    minify: false
    sourceMap: linked
    exclude:
      - aws-sdk
    target: node20
    platform: node
    concurrency: 10

